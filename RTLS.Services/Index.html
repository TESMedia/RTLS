<!DOCTYPE html>
<html>
<head>
    <title>SignalR Simple Chat</title>
    <style type="text/css">
        canvas {
            transform-origin: bottom left;
            border: 1px solid black;
            padding: 0;
            margin: auto;
            display: block;
            width: 600px;
            height: 800px;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
</head>
<body>
    <canvas id="Canvas" width="600" height="800"></canvas>

    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-1.6.4.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://10.38.129.14:8081/signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->

    <script type="text/javascript">

        var canvas = document.getElementById('Canvas');
        var context = canvas.getContext("2d");

        var img = new Image;      // First create the image...
        img.onload = function () {  // ...then set the onload handler...
            context.drawImage(img, 0, 0,600,800);
        };
        img.src = "http://10.38.129.14:85/Images/map5.jpg";

          var draw = function (x, y, mac) {
            context.drawImage(img, 0, 0, 600, 800);
            //var img = new Image;
            var img1 = new Image;// First create the image...

            var xPos = 20 * x;
            var yPos = 20 * y;
            img1.onload = function () {
            context.drawImage(img1, xPos, yPos, 20, 20);
            var markerText = mac;
            var textMeasurements = context.measureText(markerText);

            context.fillStyle = "#f2f2f2";
            context.globalAlpha = 0.9;
            context.fillRect(xPos-30, yPos-10, 90, 15);
            context.globalAlpha = 1;

            // Draw position above
            context.fillStyle = "#474747";
            context.fillText(markerText, xPos-30, yPos);
            };
            img1.src = "http://10.38.129.14:85/Images/user2.png";
        };

         var myHub = $.connection.MyHub;
         $(function () {
             // Declare a proxy to reference the hub.
             $.connection.hub.url = 'http://10.38.129.14:8081/signalr';
             $.connection.hub.logging = true;
             $.connection.hub.start().done(function () {
                 alert("Now connected!");
                 myHub.server.send().done(function () {
                     console.log("ChatHub.Send completed successfully");
                 }).fail(function (error) {
                     console.log("ChatHub.Send failed:");
                 });
             }).fail(function () {
                 alert("Could not Connect!");
             });
       });

        myHub.client.addMessage = function (value) {
             var formArray=JSON.parse(value);
             console.log("Data come from subscriber");
             formArray.forEach(function (item) {
                 console.log(item.mac);
                 console.log(item.x);
                 console.log(item.y);
                 draw(item.x, item.y, item.mac);
             });
       };
    </script>
</body>
</html>
